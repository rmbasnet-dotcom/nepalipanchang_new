import json
from datetime import datetime, timedelta
import swisseph as swe
import math

class NepaliPanchangGenerator:
    def __init__(self):
        # Initialize Swiss Ephemeris
        swe.set_ephe_path('./ephe')  # Path to ephemeris files
        
        # Kathmandu coordinates
        self.lat = 27.7172
        self.lon = 85.324
        self.timezone = 5.75  # Nepal timezone (UTC+5:45)
        
        # Month mappings for 2082 BS
        self.months = [
            {"bs_month": 1, "name": "Baisakh", "days": 31, "ad_start": "2025-04-14"},
            {"bs_month": 2, "name": "Jestha", "days": 32, "ad_start": "2025-05-15"},
            {"bs_month": 3, "name": "Ashadh", "days": 32, "ad_start": "2025-06-16"},
            {"bs_month": 4, "name": "Shrawan", "days": 32, "ad_start": "2025-07-18"},
            {"bs_month": 5, "name": "Bhadra", "days": 31, "ad_start": "2025-08-19"},
            {"bs_month": 6, "name": "Ashwin", "days": 31, "ad_start": "2025-09-19"},
            {"bs_month": 7, "name": "Kartik", "days": 30, "ad_start": "2025-10-20"},
            {"bs_month": 8, "name": "Mangsir", "days": 30, "ad_start": "2025-11-19"},
            {"bs_month": 9, "name": "Poush", "days": 30, "ad_start": "2025-12-19"},
            {"bs_month": 10, "name": "Magh", "days": 29, "ad_start": "2026-01-18"},
            {"bs_month": 11, "name": "Falgun", "days": 30, "ad_start": "2026-02-16"},
            {"bs_month": 12, "name": "Chaitra", "days": 30, "ad_start": "2026-03-18"}
        ]
        
        # Tithi names
        self.tithi_names = [
            "Pratipada", "Dwitiya", "Tritiya", "Chaturthi", "Panchami",
            "Shashthi", "Saptami", "Ashtami", "Navami", "Dashami",
            "Ekadashi", "Dwadashi", "Trayodashi", "Chaturdashi", "Purnima",
            "Pratipada", "Dwitiya", "Tritiya", "Chaturthi", "Panchami",
            "Shashthi", "Saptami", "Ashtami", "Navami", "Dashami",
            "Ekadashi", "Dwadashi", "Trayodashi", "Chaturdashi", "Amavasya"
        ]
        
        # Nakshatra names
        self.nakshatra_names = [
            "Ashwini", "Bharani", "Krittika", "Rohini", "Mrigashira",
            "Ardra", "Punarvasu", "Pushya", "Ashlesha", "Magha",
            "Purva Phalguni", "Uttara Phalguni", "Hasta", "Chitra",
            "Swati", "Vishakha", "Anuradha", "Jyeshtha", "Mula",
            "Purva Ashadha", "Uttara Ashadha", "Shravana", "Dhanishta",
            "Shatabhisha", "Purva Bhadrapada", "Uttara Bhadrapada", "Revati"
        ]
        
        # Rashi names
        self.rashi_names = [
            "Mesha (Aries)", "Vrishabha (Taurus)", "Mithuna (Gemini)",
            "Karka (Cancer)", "Simha (Leo)", "Kanya (Virgo)",
            "Tula (Libra)", "Vrishchika (Scorpio)", "Dhanu (Sagittarius)",
            "Makara (Capricorn)", "Kumbha (Aquarius)", "Meena (Pisces)"
        ]
        
        # Festivals data
        self.festivals = {
            "2082-01-01": "Nepali New Year",
            "2082-02-08": "Ram Nawami",
            "2082-03-15": "Buddha Jayanti",
            "2082-05-15": "Janai Purnima",
            "2082-05-30": "Hartalika Teej",
            "2082-06-21": "Ghatasthapana",
            "2082-06-27": "Fulpati",
            "2082-06-28": "Maha Astami",
            "2082-06-29": "Maha Nawami",
            "2082-06-30": "Vijaya Dashami",
            "2082-07-15": "Lakshmi Puja",
            "2082-07-17": "Bhai Tika",
            "2082-07-25": "Chhath Parwa",
            "2082-10-01": "Maghe Sankranti",
            "2082-11-19": "Maha Shivaratri",
            "2082-11-30": "Holi",
            "2082-12-29": "Chaite Dashain"
        }
    
    def calculate_tithi(self, jd):
        """Calculate tithi index (0-29)"""
        sun = swe.calc_ut(jd, swe.SUN)[0][0]
        moon = swe.calc_ut(jd, swe.MOON)[0][0]
        
        # Tithi = (moon - sun) / 12°
        tithi = ((moon - sun) % 360) / 12
        return int(tithi)
    
    def calculate_nakshatra(self, jd):
        """Calculate nakshatra index (0-26)"""
        moon = swe.calc_ut(jd, swe.MOON)[0][0]
        # Each nakshatra is 13°20' (13.3333°)
        nakshatra = int(moon / 13.333333)
        return nakshatra % 27
    
    def calculate_rashi(self, jd, body):
        """Calculate rashi for sun or moon"""
        pos = swe.calc_ut(jd, body)[0][0]
        return int(pos / 30) % 12
    
    def get_sunrise_sunset(self, jd):
        """Calculate sunrise and sunset times"""
        # Simplified calculation - in production use proper sunrise equation
        month = datetime.fromtimestamp(swe.jdut1_to_utc(jd, 0)[0]).month
        
        if 4 <= month <= 8:  # Summer
            sunrise = "05:30"
            sunset = "18:45"
        elif month >= 9 and month <= 11:  # Autumn
            sunrise = "06:00"
            sunset = "18:15"
        else:  # Winter
            sunrise = "06:30"
            sunset = "17:45"
            
        return sunrise, sunset
    
    def get_rahu_kaal(self, weekday, sunrise, sunset):
        """Calculate Rahu Kaal based on weekday"""
        # Convert sunrise/sunset to hours
        sunrise_h = int(sunrise.split(':')[0]) + int(sunrise.split(':')[1])/60
        sunset_h = int(sunset.split(':')[0]) + int(sunset.split(':')[1])/60
        day_duration = sunset_h - sunrise_h
        segment = day_duration / 8
        
        # Rahu Kaal segments by weekday (1/8th of daytime)
        rahu_segments = {
            0: 7,  # Sunday: 8th segment
            1: 1,  # Monday: 2nd segment
            2: 6,  # Tuesday: 7th segment
            3: 4,  # Wednesday: 5th segment
            4: 5,  # Thursday: 6th segment
            5: 3,  # Friday: 4th segment
            6: 2   # Saturday: 3rd segment
        }
        
        segment_num = rahu_segments[weekday]
        start = sunrise_h + (segment_num - 1) * segment
        end = start + segment
        
        # Convert back to time string
        start_h = int(start)
        start_m = int((start - start_h) * 60)
        end_h = int(end)
        end_m = int((end - end_h) * 60)
        
        return f"{start_h:02d}:{start_m:02d}", f"{end_h:02d}:{end_m:02d}"
    
    def generate_daily_data(self):
        """Generate complete daily panchang data"""
        daily_data = []
        weekdays = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"]
        
        for month in self.months:
            ad_start = datetime.strptime(month["ad_start"], "%Y-%m-%d")
            
            for day in range(1, month["days"] + 1):
                current_date = ad_start + timedelta(days=day-1)
                
                # Convert to Julian day
                jd = swe.julday(
                    current_date.year,
                    current_date.month,
                    current_date.day,
                    12.0  # Noon
                )
                
                # Calculate panchang elements
                tithi_idx = self.calculate_tithi(jd)
                nakshatra_idx = self.calculate_nakshatra(jd)
                sun_rashi = self.calculate_rashi(jd, swe.SUN)
                moon_rashi = self.calculate_rashi(jd, swe.MOON)
                
                date_bs = f"2082-{month['bs_month']:02d}-{day:02d}"
                weekday_num = current_date.weekday()
                # Convert Python weekday (0=Monday) to Sunday=0
                weekday_num = (weekday_num + 1) % 7
                
                sunrise, sunset = self.get_sunrise_sunset(jd)
                rahu_start, rahu_end = self.get_rahu_kaal(weekday_num, sunrise, sunset)
                
                # Determine paksha (fortnight)
                paksha = "Shukla Paksha" if tithi_idx < 15 else "Krishna Paksha"
                tithi_name = self.tithi_names[tithi_idx]
                
                daily_entry = {
                    "date_bs": date_bs,
                    "date_ad": current_date.strftime("%Y-%m-%d"),
                    "weekday": weekdays[weekday_num],
                    "tithi": {
                        "index": tithi_idx + 1,
                        "name_en": tithi_name,
                        "paksha": paksha
                    },
                    "nakshatra": {
                        "index": nakshatra_idx + 1,
                        "name_en": self.nakshatra_names[nakshatra_idx]
                    },
                    "rashi": {
                        "sun": {
                            "index": sun_rashi + 1,
                            "name_en": self.rashi_names[sun_rashi]
                        },
                        "moon": {
                            "index": moon_rashi + 1,
                            "name_en": self.rashi_names[moon_rashi]
                        }
                    },
                    "rahu_kaal": {
                        "start": rahu_start,
                        "end": rahu_end,
                        "duration_minutes": int((self._time_to_minutes(rahu_end) - self._time_to_minutes(rahu_start)))
                    },
                    "sunrise": sunrise,
                    "sunset": sunset,
                    "festival": self.festivals.get(date_bs, "None"),
                    "masa": month["name"]
                }
                
                daily_data.append(daily_entry)
                
        return daily_data
    
    def _time_to_minutes(self, time_str):
        h, m = map(int, time_str.split(':'))
        return h * 60 + m
    
    def generate_complete_json(self):
        """Generate complete JSON structure"""
        daily_data = self.generate_daily_data()
        
        return {
            "metadata": {
                "name": "Nepali Panchang - Complete with Calculations",
                "version": "2.0",
                "description": "Complete panchang data with accurate Tithi, Nakshatra, and Rashi calculations",
                "generated": datetime.now().strftime("%Y-%m-%d"),
                "total_days": len(daily_data),
                "location": {
                    "lat": self.lat,
                    "lon": self.lon,
                    "timezone": "UTC+5:45 (Nepal Time)"
                }
            },
            "data": daily_data
        }

# Generate and save
if __name__ == "__main__":
    generator = NepaliPanchangGenerator()
    panchang_data = generator.generate_complete_json()
    
    # Save to file
    with open("panchang_data.json", "w", encoding="utf-8") as f:
        json.dump(panchang_data, f, indent=2, ensure_ascii=False)
    
    print(f"Generated {panchang_data['metadata']['total_days']} days of panchang data")
